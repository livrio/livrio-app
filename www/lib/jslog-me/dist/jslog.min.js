/*! jslog 2015-02-28 */

!function(a,b){"use strict";b([],a)}(function(){"use strict";var a,b,c="jslog.me",d="/log",e="//"+c+d,f=1e4,g=1e4,h=4194304,i=5240,j=1048576,k="JSLOG_ME_POSTPONED_ITEMS",l="http:",m=!1;return function(){function n(){this.enabled=!0,this.logUncaughtExceptions=!0,this.hookConsole=!0,this.trackHost=!0,this.collectSystemInfo=!0,this.trackLaunches=!0,this.key="",this.version="",this.sessionId=this.guid()}function o(){if(this.inOperation=!1,this.xmlHttpRequest=B(),this.http=null,!this.xmlHttpRequest)try{this.http=require("http")}catch(a){this.http=null}}function p(){this.timePrefix=A()+"",this.counter=0,this.postponed={},this.postponedLength=0,this.postponedSize=0,this.lastItem=void 0,this.loadPostponedData()}function q(a,b){if("object"==typeof window&&window&&window.localStorage)try{window.localStorage[k+a]=b}catch(c){}}function r(a,b){var c=a.match(F),d=b.match(F);return c&&d&&c.length>1&&d.length>1?"["+c[1]+", "+d[1]+"]":c?a:d?b:"[]"}function s(a,b,c,d){this.protocol=a,this.sender=b,this.queue=c,this.logger=d,this.start()}function t(a){this.options=new n,void 0!==a&&(this.options=this.parseOptions(a));var b;"undefined"!=typeof window?(b=window.location.protocol,"http:"!==b.toLowerCase()&&"https:"!==b.toLowerCase()&&(b=l)):b=l,this.protocol=b,this.systemInfoSent=!1,this._batchQueue=[],this._packetSize=0,this.senderService=new o,this.pendingSenderService=new s(b,this.senderService,L,this),this.init()}function u(a){if(a._batchQueue.length){var b=x(a);a.postpone(b)}}function v(a,b,c,d){if(d=!!d,y(b)>h){var e=x(b);b.postpone(e)}if(c&&w(b,c),(!b.senderService.inOperation||d)&&b._batchQueue.length){var f=x(b);b.senderService.sendPacket(a,f,d,function(){v(a,b,void 0,!1)},function(){b.postpone(f),v(a,b,void 0,!1)})}}function w(a,b){a._batchQueue.push(b)}function x(a){var b="["+a._batchQueue.join(", ")+"]";return a._batchQueue=[],b}function y(a){for(var b=0,c=0;c<a._batchQueue.length;c++)b+=a._batchQueue[c].length;return b}function z(a,b){return function(){return b.apply(a,arguments)}}function A(){return Date.now?Date.now():(new Date).getTime()}function B(){try{return"undefined"==typeof XMLHttpRequest&&(XMLHttpRequest=function(){try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(a){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(a){}throw new Error("XMLHttpRequest not supported")}),new XMLHttpRequest}catch(a){return void 0}}function C(a){a.systemInfoSent||a.systemInfo(a.options.collectSystemInfo)}function D(a){if(a instanceof Array){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(t.prototype.expand(a[c]));return b}return t.prototype.expand(a)}function E(a){var b={};return a?("undefined"!=typeof a.name&&(b.name=a.name),"undefined"!=typeof a.message&&(b.message=a.message),"undefined"!=typeof a.stack&&(b.stack=a.stack),"undefined"!=typeof a.fileName&&(b.fileName=a.fileName),"undefined"!=typeof a.lineNumber&&(b.lineNumber=a.lineNumber),"undefined"!=typeof a.columnNumber&&(b.columnNumber=a.columnNumber),"undefined"!=typeof a.description&&(b.description=a.description),b):b}n.prototype.guid=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}(),o.prototype.sendXmlHttpRequest=function(a,b,c,d,f){var h=this,i=this.xmlHttpRequest;this.inOperation=!0,i.open("POST",a+e,!0),i.timeout=g,i.setRequestHeader("Content-Type","application/json; charset=UTF-8"),i.onreadystatechange=function(){4===i.readyState&&(h.inOperation=!1,200===i.status||400===i.status?d(b):f(b))};try{i.send(b)}catch(j){f(b)}},o.prototype.sendNodeJsHttpRequest=function(a,b){var e={host:c,port:"80",path:d,method:"POST",headers:{"Content-Type":"application/json"}},f=this.http.request(e,function(){});f.write(b),f.end()},o.prototype.sendPacket=function(a,b,c,d,e){return this.inOperation&&!c?void e(b):void(this.xmlHttpRequest?this.sendXmlHttpRequest(a,b,c,d,e):this.http&&this.sendNodeJsHttpRequest(a,b,c,d,e))},p.prototype.loadPostponedData=function(){if("object"!=typeof window||!window||!window.localStorage)return void 0;try{this.postponed={},this.lastItem=void 0,this.postponedSize=0;var a=k.length,b=0;for(var c in window.localStorage)if(window.localStorage.hasOwnProperty(c)&&0===c.indexOf(k)){var d=c.substr(a);this.lastItem=d,this.postponed[d]=window.localStorage[c],this.postponedSize=this.postponedSize+this.postponed[d].length,b++}return this.postponedLength=b,b?this.postponed:void 0}catch(e){return void 0}},p.prototype.add=function(a){function b(){c.counter++,c.lastItem=c.timePrefix+c.counter,c.postponed[c.lastItem]=a,c.postponedSize=c.postponedSize+a.length,q(c.lastItem,a)}var c=this;if(!(c.postponedSize>j))if(this.lastItem){var d=this.postponed[c.lastItem];if(d.length>i)b();else{var e=r(d,a);c.postponed[c.lastItem]=e,q(c.lastItem,e),c.postponedSize=c.postponedSize+e.length-d.length}}else b()};var F=/^\s*\[\s*(.+)\s*\]\s*$/;p.prototype.haveItems=function(){return this.postponedLength},p.prototype.fetchItem=function(){if(!this.postponedLength)return void 0;for(var a in this.postponed)if(this.postponed.hasOwnProperty(a))return{key:a,value:this.postponed[a]};return void 0},p.prototype.deleteItem=function(a){if(this.postponedLength--,this.postponedSize=this.postponedSize-this.postponed[a].length,delete this.postponed[a],"object"==typeof window&&window&&window.localStorage)try{delete window.localStorage[k+a]}catch(b){}this.lastItem===a&&(this.lastItem=void 0)},s.prototype.sendPendingItem=function(){if(!this.sender.inOperation&&this.queue.haveItems()){var a=this.queue.fetchItem(),b=this;if(a){var c=a.key,d=a.value;this.sender.sendPacket(this.protocol,d,!1,function(){b.queue.deleteItem(c),b.sendPendingItem()},function(){u(b.logger)})}}},s.prototype.start=function(){if(!this.handle){var a=this;this.handle=setInterval(function(){a.sendPendingItem()},f)}},s.prototype.stop=function(){this.handle&&(clearInterval(this.handle),this.handle=void 0)},t.prototype.renewSession=function(){this.options.sessionId=this.options.guid(),this.systemInfoSent=!1},t.prototype.parseOptions=function(a){var b=new n;for(var c in a)a.hasOwnProperty(c)&&b.hasOwnProperty(c)&&(b[c]=a[c]);return b},t.prototype.sendToServer=function(a,c,d){if(this.options.enabled){d instanceof Error&&(d=E(d));var e={key:a,sessionId:this.options.sessionId,hostId:b,time:A(),type:c,data:d},f=JSON.stringify(e);v(this.protocol,this,f)}},t.prototype.postpone=function(a){L.add(a)},t.prototype.log=function(){try{C(this);var a=arguments.length>1?arguments:arguments[0];this.sendToServer(this.options.key,"log",a),"function"==typeof G&&G.apply(console,arguments)}catch(b){}},t.prototype.expand=function(a){function b(a){if("object"!=typeof a||null===a)return a;var d={},e=Object.getOwnPropertyNames(a).sort();c.push(a);for(var f in e)if(e.hasOwnProperty(f)){var g=e[f],h=a[g];if("undefined"==typeof h||"function"==typeof h)continue;c.indexOf(h)>=0&&(h="<circular ref>"),d[g]=b(h)}return c.pop(),d}var c=[];return b(a)},t.prototype.info=function(){try{C(this);var a=arguments.length>1?arguments:arguments[0];this.sendToServer(this.options.key,"info",a),"function"==typeof J&&J.apply(console,arguments)}catch(b){}},t.prototype.warn=function(){try{C(this);var a=arguments.length>1?arguments:arguments[0];this.sendToServer(this.options.key,"warn",a),"function"==typeof H&&H.apply(console,arguments)}catch(b){}},t.prototype.error=function(){try{C(this);var a=arguments.length>1?arguments:arguments[0];this.sendToServer(this.options.key,"error",D(a)),"function"==typeof I&&I.apply(console,arguments)}catch(b){}},t.prototype.exception=function(){try{C(this);var a=arguments.length>1?arguments:arguments[0];this.sendToServer(this.options.key,"exception",D(a)),"function"==typeof K&&K.apply(console,arguments)}catch(b){}},t.prototype.systemInfo=function(a){try{var b={};a&&"object"==typeof navigator?(b.userAgent=navigator.userAgent,b.platform=navigator.platform,b.version=this.options.version):(b.userAgent="",b.platform="",b.version=this.options.version),this.systemInfoSent=!0,this.sendToServer(this.options.key,"systemInfo",b)}catch(c){}},t.prototype.init=function(){this.options.enabled&&(this.pendingSenderService.sendPendingItem(),this.options.trackHost&&this.trackHost(),this.options.hookConsole&&this.hookConsole(),this.options.logUncaughtExceptions&&this.hookUncaughtExceptions(),this.options.trackLaunches&&this.systemInfo(this.options.collectSystemInfo))};var G,H,I,J,K;t.prototype.trackHost=function(){if(!b)if("object"==typeof window&&"localStorage"in window&&null!==window.localStorage){try{b=window.localStorage.getItem("JsLogToken")}catch(a){b=null}if(!b){b=n.prototype.guid();try{window.localStorage.setItem("JsLogToken",b)}catch(a){}}}else b=n.prototype.guid()},t.prototype.hookConsole=function(){m||("undefined"!=typeof console?(G=console.log,H=console.warn,I=console.error,J=console.info,K=console.exception,console.log=z(this,this.log),console.warn=z(this,this.warn),console.error=z(this,this.error),console.info=z(this,this.info),console.exception=z(this,this.exception)):console={log:z(this,this.log),warn:z(this,this.warn),error:z(this,this.error),info:z(this,this.info),exception:z(this,this.exception)},m=!0)},t.prototype.hookUncaughtExceptions=function(){"undefined"!=typeof window&&(window.onerror=z(this,this.windowErrorHandler)),"undefined"!=typeof process&&process.on("uncaughtException",z(this,this.windowErrorHandler))},t.prototype.windowErrorHandler=function(a,b,c,d,e){if(this.options.enabled)try{e?this.sendToServer(this.options.key,"uncaughtException",{msg:a,url:b,line:c,column:d,errorObj:E(e)}):this.sendToServer(this.options.key,"uncaughtException",E(a))}catch(f){}};var L=new p;"undefined"!=typeof window&&(window.JsLog=window.JsLog||t),a=t}(),a},"function"==typeof define&&define.amd?define:function(a,b){"undefined"!=typeof module?module.exports=b():b()});
//# sourceMappingURL=jslog.min.js.map